# ホスト側スクリプトの例

RTCが無いラズパイ等に接続して，RTC代わりに使うことを想定したスクリプトになっています．

stickdist.py が，M5Stackを操作するためスクリプト，stickdisp_start.shが，そのスクリプトを起動するためのスクリプトになります．

## 動作確認

```shell
python3 stickdisp.py --port /dev/ttyUSB0 -r
```

として，RTCを読みだしてみます．M5stickに表示されているのと同じ時刻が表示されればOKです．


## M5stickの時計を合わせる

ntpdate等のコマンドを使って，まずOSの時計を合わせておきます．次に，
```shell
python3 stickdisp.py --port /dev/ttyUSB0 -w
```

とします．これで時計が合ったはずです．


## stickdisp.pyの修正すべき箇所

ボタンが押されたときに何をするか，という動作の部分を記述する必要があります．

def disp_callback(disp): という行を探してください．そこに，ボタンが押された場合のコールバック関数が記述されています．

```python
s = disp.get_rxstr()
```

という部分で，どういう状況でどのボタンが押されたのかを取得します．
ここで得られる文字列は，"b0A" という形式で，最初の'b'がボタンの押下，次の0が画面0(時計が出ている画面)を表示している状態で，'A'ボタンが押された，という意味になります．

今は，時計画面でAボタンを押すとLEDの点灯状態をトグルするようになっていますので，ここに，何らかの外部スクリプトを起動するような記述をすれば，時計画面でAボタンを押すと，何かのスクリプトが走る，という動作を実現できます．

また，シャットダウン画面への応答は，実際のシャットダウン動作に関する部分はコメントアウトしてありますので，必要に応じてコメントを外し，実際にシャットダウンされるようにしてください．


## stickdisp_start.shの修正すべき箇所

stickdisp.py を起動するためのスクリプトです．
時計画面に，IPアドレスとホスト名を表示するようになっています．
スクリプト先頭部分に

```shell
INTERFACE=eth0
TTYDEV=/dev/ttyUSB0
```

という部分があります．INTERFACEがIPアドレスを取り出したいインターフェース名，TTYDEVがM5stickが接続されるデバイス名です．必要に応じてここを修正してください．

```shell
RTC=$(python3 "$DISPSCRIPT" --port $TTYDEV --rtc)
```
という部分でRTCを読みだしています．また，M5Stickの接続確認も兼ねています．もし，ホスト側がRTCを持たないのであれば，ここで取得した時刻を使ってシステム時刻を設定することが出来ます

```shell
# date -s "$RTC"
```
という行がコメントになっていますが，この行を有効にすればシステム時刻の設定が行われます．


```shell
python3 "$DISPSCRIPT" -u --text1 "$MYIP" --text2 "$(hostname)" --port $TTYDEV
```

という行で，python側のスクリプトが実行されます．-u オプションがあると，1分に1回，OSの時刻をRTCへ書き込みます．OSの時計がNTP等で外部と同期されており，常に正い時刻が得られる場合にはこのオプションを付けて置いてください．OSの時刻が信用できない場合には，このオプションは削除してください．

## インストール

stickdisp_start.sh 及び stickdisp.py を /usr/local/bin にコピーしてください．この2つのファイルが同じディレクトリに存在するのであれば，他のディレクトリでも構いません．

/etc/rc.local 等の起動スクリプトから，stickdisp_start.sh を呼び出すようにしてください．

